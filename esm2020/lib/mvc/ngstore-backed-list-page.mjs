import { NgStoreListMediator } from '@polpware/fe-mvc';
import { CollectionStore } from '@polpware/fe-data';
// base
import { FullFeatureListPage } from './full-feature-list-page';
// Note that in the class, please avoid to depend on onNewItemsReady,
// as it is NOT in the update flow.
export class NgStoreBackedListPage extends FullFeatureListPage {
    constructor() {
        super();
        this.defaultLivePeriod = 60 * 5;
        this.mediatorCtorOptions = {
            useModel: true,
            enableInfinite: true,
            enableRefresh: true
        };
        this.items = [];
        this._onCacheExpireCallback = null;
    }
    // Override
    turnOnMediator(fromCache) {
        super.turnOnMediator(fromCache);
        const store = this.asNgStoreListMeidator.getNgStore();
        this._storeSubscription = store.getState().subscribe((data) => {
            const w = data.items;
            this.items = w;
            // Note that we must call onItemsReady ... 
            this.onItemsReady();
        });
    }
    // Override
    turnOffMediator() {
        this._storeSubscription.unsubscribe();
        super.turnOffMediator();
    }
    // Override
    buildMediator(dataProvider) {
        const ctorOptions = {
            ...this.mediatorCtorOptions,
            dataProvider: dataProvider
        };
        const s = new CollectionStore();
        const m = new NgStoreListMediator(ctorOptions);
        m.setNgStore(s);
        this.listMediator = m;
        this.listMediator.setUp();
        return Promise.resolve();
    }
    get asNgStoreListMeidator() {
        const m = this.listMediator;
        return m;
    }
    readMediatorFromCache(key) {
        return this.mediatorCache.get(key, this.defaultLivePeriod);
    }
    writeMediatorIntoCache(key, value) {
        this.mediatorCache.set(key, value, this.defaultLivePeriod, (evt) => {
            value.tearDown();
            return evt;
        });
    }
    addOnCacheExpireHandler(key) {
        this._onCacheExpireCallback = function (evt) {
            evt.preventDefault();
            return evt;
        };
        this.mediatorCache.addOnExpireHandler(key, this._onCacheExpireCallback);
    }
    removeOnCacheExpireHandler(key) {
        this.mediatorCache.rmOnExpireHandler(key, this._onCacheExpireCallback);
        this._onCacheExpireCallback = null;
    }
    // Default implementation.
    // Override
    // Note that in the derived class we do NOT depend on it.
    onNewItemsReady(items) {
        return items;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmdzdG9yZS1iYWNrZWQtbGlzdC1wYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcG9scHdhcmUvbmd4LW12Yy9zcmMvbGliL212Yy9uZ3N0b3JlLWJhY2tlZC1saXN0LXBhZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBTUEsT0FBTyxFQUNILG1CQUFtQixFQUV0QixNQUFNLGtCQUFrQixDQUFDO0FBTTFCLE9BQU8sRUFDSCxlQUFlLEVBQ2xCLE1BQU0sbUJBQW1CLENBQUM7QUFPM0IsT0FBTztBQUNQLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRS9ELHFFQUFxRTtBQUNyRSxtQ0FBbUM7QUFFbkMsTUFBTSxPQUFnQixxQkFDbEIsU0FBUSxtQkFBbUI7SUFhM0I7UUFDSSxLQUFLLEVBQUUsQ0FBQztRQVpGLHNCQUFpQixHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFjakMsSUFBSSxDQUFDLG1CQUFtQixHQUFHO1lBQ3ZCLFFBQVEsRUFBRSxJQUFJO1lBQ2QsY0FBYyxFQUFFLElBQUk7WUFDcEIsYUFBYSxFQUFFLElBQUk7U0FDdEIsQ0FBQztRQUNGLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUM7SUFDdkMsQ0FBQztJQUVELFdBQVc7SUFDRCxjQUFjLENBQUMsU0FBa0I7UUFDdkMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDdEQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUMxRCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBWSxDQUFDO1lBQzVCLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsMkNBQTJDO1lBQzNDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxXQUFXO0lBQ0QsZUFBZTtRQUNyQixJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDdEMsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRCxXQUFXO0lBQ0QsYUFBYSxDQUFDLFlBQWlCO1FBRXJDLE1BQU0sV0FBVyxHQUE2QjtZQUMxQyxHQUFHLElBQUksQ0FBQyxtQkFBbUI7WUFDM0IsWUFBWSxFQUFFLFlBQVk7U0FDN0IsQ0FBQztRQUVGLE1BQU0sQ0FBQyxHQUFHLElBQUksZUFBZSxFQUFLLENBQUM7UUFFbkMsTUFBTSxDQUFDLEdBQStCLElBQUksbUJBQW1CLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0UsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVoQixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRTFCLE9BQU8sT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRCxJQUFjLHFCQUFxQjtRQUMvQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO1FBQzVCLE9BQU8sQ0FBK0IsQ0FBQztJQUMzQyxDQUFDO0lBRVMscUJBQXFCLENBQUMsR0FBVztRQUN2QyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBRVMsc0JBQXNCLENBQUMsR0FBVyxFQUFFLEtBQWlDO1FBQzNFLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDL0QsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sR0FBRyxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRVMsdUJBQXVCLENBQUMsR0FBVztRQUN6QyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsVUFBUyxHQUFHO1lBQ3RDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNyQixPQUFPLEdBQUcsQ0FBQztRQUNmLENBQUMsQ0FBQztRQUVGLElBQUksQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFUywwQkFBMEIsQ0FBQyxHQUFXO1FBQzVDLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUM7SUFDdkMsQ0FBQztJQUVELDBCQUEwQjtJQUMxQixXQUFXO0lBQ1gseURBQXlEO0lBQ3pELGVBQWUsQ0FBQyxLQUFVO1FBQ3RCLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1xuICAgIElMaXN0TWVkaWF0b3JDdG9yT3B0aW9uc1xufSBmcm9tICdAcG9scHdhcmUvZmUtbXZjJztcblxuaW1wb3J0IHtcbiAgICBOZ1N0b3JlTGlzdE1lZGlhdG9yLFxuICAgIElOZ1N0b3JlTGlzdE1lZGlhdG9yUHVibGljXG59IGZyb20gJ0Bwb2xwd2FyZS9mZS1tdmMnO1xuXG5pbXBvcnQge1xuICAgIElDb2xsZWN0aW9uSXRlbVxufSBmcm9tICdAcG9scHdhcmUvZmUtZGF0YSc7XG5cbmltcG9ydCB7XG4gICAgQ29sbGVjdGlvblN0b3JlXG59IGZyb20gJ0Bwb2xwd2FyZS9mZS1kYXRhJztcblxuXG5pbXBvcnQge1xuICAgIElTbGlkaW5nRXhwaXJlQ2FjaGVcbn0gZnJvbSAnQHBvbHB3YXJlL2ZlLWRhdGEnO1xuXG4vLyBiYXNlXG5pbXBvcnQgeyBGdWxsRmVhdHVyZUxpc3RQYWdlIH0gZnJvbSAnLi9mdWxsLWZlYXR1cmUtbGlzdC1wYWdlJztcblxuLy8gTm90ZSB0aGF0IGluIHRoZSBjbGFzcywgcGxlYXNlIGF2b2lkIHRvIGRlcGVuZCBvbiBvbk5ld0l0ZW1zUmVhZHksXG4vLyBhcyBpdCBpcyBOT1QgaW4gdGhlIHVwZGF0ZSBmbG93LlxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgTmdTdG9yZUJhY2tlZExpc3RQYWdlPFQgZXh0ZW5kcyBJQ29sbGVjdGlvbkl0ZW0+XG4gICAgZXh0ZW5kcyBGdWxsRmVhdHVyZUxpc3RQYWdlIHtcblxuICAgIHByb3RlY3RlZCBkZWZhdWx0TGl2ZVBlcmlvZCA9IDYwICogNTtcblxuICAgIC8vIE1vcmUgY29uZmlndXJhdGlvbiBmb3IgY29uc3RydWN0aW5nIGRhdGFwcm92aWRlclxuICAgIHByb3RlY3RlZCBtZWRpYXRvckN0b3JPcHRpb25zOiBJTGlzdE1lZGlhdG9yQ3Rvck9wdGlvbnM7XG5cbiAgICBwcm90ZWN0ZWQgbWVkaWF0b3JDYWNoZTogSVNsaWRpbmdFeHBpcmVDYWNoZTxJTmdTdG9yZUxpc3RNZWRpYXRvclB1YmxpYz47XG4gICAgcHJpdmF0ZSBfb25DYWNoZUV4cGlyZUNhbGxiYWNrOiBhbnk7XG5cbiAgICBwcml2YXRlIF9zdG9yZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICAgIHB1YmxpYyBpdGVtczogVFtdO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5tZWRpYXRvckN0b3JPcHRpb25zID0ge1xuICAgICAgICAgICAgdXNlTW9kZWw6IHRydWUsXG4gICAgICAgICAgICBlbmFibGVJbmZpbml0ZTogdHJ1ZSxcbiAgICAgICAgICAgIGVuYWJsZVJlZnJlc2g6IHRydWVcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5pdGVtcyA9IFtdO1xuICAgICAgICB0aGlzLl9vbkNhY2hlRXhwaXJlQ2FsbGJhY2sgPSBudWxsO1xuICAgIH1cblxuICAgIC8vIE92ZXJyaWRlXG4gICAgcHJvdGVjdGVkIHR1cm5Pbk1lZGlhdG9yKGZyb21DYWNoZTogYm9vbGVhbikge1xuICAgICAgICBzdXBlci50dXJuT25NZWRpYXRvcihmcm9tQ2FjaGUpO1xuXG4gICAgICAgIGNvbnN0IHN0b3JlID0gdGhpcy5hc05nU3RvcmVMaXN0TWVpZGF0b3IuZ2V0TmdTdG9yZSgpO1xuICAgICAgICB0aGlzLl9zdG9yZVN1YnNjcmlwdGlvbiA9IHN0b3JlLmdldFN0YXRlKCkuc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB3ID0gZGF0YS5pdGVtcyBhcyBUW107XG4gICAgICAgICAgICB0aGlzLml0ZW1zID0gdztcbiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCB3ZSBtdXN0IGNhbGwgb25JdGVtc1JlYWR5IC4uLiBcbiAgICAgICAgICAgIHRoaXMub25JdGVtc1JlYWR5KCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIE92ZXJyaWRlXG4gICAgcHJvdGVjdGVkIHR1cm5PZmZNZWRpYXRvcigpIHtcbiAgICAgICAgdGhpcy5fc3RvcmVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgc3VwZXIudHVybk9mZk1lZGlhdG9yKCk7XG4gICAgfVxuXG4gICAgLy8gT3ZlcnJpZGVcbiAgICBwcm90ZWN0ZWQgYnVpbGRNZWRpYXRvcihkYXRhUHJvdmlkZXI6IGFueSk6IFByb21pc2VMaWtlPHZvaWQ+IHtcblxuICAgICAgICBjb25zdCBjdG9yT3B0aW9uczogSUxpc3RNZWRpYXRvckN0b3JPcHRpb25zID0ge1xuICAgICAgICAgICAgLi4udGhpcy5tZWRpYXRvckN0b3JPcHRpb25zLFxuICAgICAgICAgICAgZGF0YVByb3ZpZGVyOiBkYXRhUHJvdmlkZXJcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBzID0gbmV3IENvbGxlY3Rpb25TdG9yZTxUPigpO1xuXG4gICAgICAgIGNvbnN0IG06IElOZ1N0b3JlTGlzdE1lZGlhdG9yUHVibGljID0gbmV3IE5nU3RvcmVMaXN0TWVkaWF0b3IoY3Rvck9wdGlvbnMpO1xuICAgICAgICBtLnNldE5nU3RvcmUocyk7XG5cbiAgICAgICAgdGhpcy5saXN0TWVkaWF0b3IgPSBtO1xuICAgICAgICB0aGlzLmxpc3RNZWRpYXRvci5zZXRVcCgpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0IGFzTmdTdG9yZUxpc3RNZWlkYXRvcigpOiBJTmdTdG9yZUxpc3RNZWRpYXRvclB1YmxpYyB7XG4gICAgICAgIGNvbnN0IG0gPSB0aGlzLmxpc3RNZWRpYXRvcjtcbiAgICAgICAgcmV0dXJuIG0gYXMgSU5nU3RvcmVMaXN0TWVkaWF0b3JQdWJsaWM7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHJlYWRNZWRpYXRvckZyb21DYWNoZShrZXk6IHN0cmluZyk6IElOZ1N0b3JlTGlzdE1lZGlhdG9yUHVibGljIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWVkaWF0b3JDYWNoZS5nZXQoa2V5LCB0aGlzLmRlZmF1bHRMaXZlUGVyaW9kKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgd3JpdGVNZWRpYXRvckludG9DYWNoZShrZXk6IHN0cmluZywgdmFsdWU6IElOZ1N0b3JlTGlzdE1lZGlhdG9yUHVibGljKTogdm9pZCB7XG4gICAgICAgIHRoaXMubWVkaWF0b3JDYWNoZS5zZXQoa2V5LCB2YWx1ZSwgdGhpcy5kZWZhdWx0TGl2ZVBlcmlvZCwgKGV2dCkgPT4ge1xuICAgICAgICAgICAgdmFsdWUudGVhckRvd24oKTtcbiAgICAgICAgICAgIHJldHVybiBldnQ7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhZGRPbkNhY2hlRXhwaXJlSGFuZGxlcihrZXk6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLl9vbkNhY2hlRXhwaXJlQ2FsbGJhY2sgPSBmdW5jdGlvbihldnQpIHtcbiAgICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgcmV0dXJuIGV2dDtcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLm1lZGlhdG9yQ2FjaGUuYWRkT25FeHBpcmVIYW5kbGVyKGtleSwgdGhpcy5fb25DYWNoZUV4cGlyZUNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVtb3ZlT25DYWNoZUV4cGlyZUhhbmRsZXIoa2V5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5tZWRpYXRvckNhY2hlLnJtT25FeHBpcmVIYW5kbGVyKGtleSwgdGhpcy5fb25DYWNoZUV4cGlyZUNhbGxiYWNrKTtcbiAgICAgICAgdGhpcy5fb25DYWNoZUV4cGlyZUNhbGxiYWNrID0gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBEZWZhdWx0IGltcGxlbWVudGF0aW9uLlxuICAgIC8vIE92ZXJyaWRlXG4gICAgLy8gTm90ZSB0aGF0IGluIHRoZSBkZXJpdmVkIGNsYXNzIHdlIGRvIE5PVCBkZXBlbmQgb24gaXQuXG4gICAgb25OZXdJdGVtc1JlYWR5KGl0ZW1zOiBUW10pIHtcbiAgICAgICAgcmV0dXJuIGl0ZW1zO1xuICAgIH1cblxufVxuXG4iXX0=