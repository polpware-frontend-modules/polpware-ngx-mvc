import { pushArray } from '@polpware/fe-utilities';
import { WritableListMediator } from '@polpware/fe-mvc';
import { RxjsPoweredWritableListMediator } from '@polpware/fe-mvc';
// base
import { FullFeatureListPage } from './full-feature-list-page';
// Note that we use ICollectionItem rather than IModelLike,
// because we assume the least requirement for the input type.
// Precisely, the only requirement is that the collection item has an
// id field. 
export class BackboneBackedListPage extends FullFeatureListPage {
    constructor() {
        super();
        this.defaultLivePeriod = 60 * 5;
        this.items = [];
        this._onCacheExpireCallback = null;
    }
    get asWritableListMediator() {
        const m = this.listMediator;
        return m;
    }
    // Default implementation for using backbone
    useMediatorWithOnlyLocalDataProvider(localDataProvider, localOptions) {
        const ctorOptions = {
            dataProvider: localDataProvider,
            useModel: true,
            enableInfinite: true,
            enableRefresh: true
        };
        const s = new WritableListMediator(ctorOptions);
        this.listMediator = s;
        this.listMediator.setUp();
    }
    useMediatorWithGlobalDataProvider(localDataProvider, globalDataProvider, localOptions, globalOptions) {
        const mediator = new RxjsPoweredWritableListMediator({
            globalProvider: globalDataProvider,
            filterFlags: {
                added: true,
                removed: true,
                updated: false
            },
            dataProvider: localDataProvider,
            useModel: true
        });
        this.listMediator = mediator;
        this.listMediator.setUp();
    }
    // Invoked after the new mediator is constructure 
    postUseFreshMediator(...args) {
        this.turnOnMediator(false, ...args);
        this.afterMediatorOn();
    }
    // Invoked after the cached mediator is used 
    postUseCachedMediator(...args) {
        this.turnOnMediator(true, ...args);
        this.afterMediatorOn();
    }
    // Override to support cache
    ensureDataProvider(...args) {
        if (this.mediatorCache) {
            const cacheKey = this.getCacheKey(...args);
            let inCache = false;
            const mediator = this.readMediatorFromCache(cacheKey);
            if (!mediator) { // Not in cache
                this.buildMediator(...args).then(() => {
                    // set up in the cache
                    this.writeMediatorIntoCache(cacheKey, this.asWritableListMediator);
                    // case 1:
                    this.postUseFreshMediator(true, ...args);
                });
            }
            else { // In cache
                inCache = true;
                this.listMediator = mediator;
                // Case 2:
                this.postUseCachedMediator(...args);
            }
        }
        else {
            this.buildMediator(...args).then(() => {
                // Case 3: 
                this.postUseFreshMediator(false, ...args);
            });
        }
    }
    // Override
    afterMediatorOn() {
        if (this.mediatorCache) {
            // In this case, we do not Provide any inputs 
            const cacheKey = this.getCacheKey();
            this.addOnCacheExpireHandler(cacheKey);
        }
    }
    // Override
    afterMediatorOff() {
        if (this.mediatorCache) {
            // In this case, we do not Provide any inputs
            const cacheKey = this.getCacheKey();
            this.removeOnCacheExpireHandler(cacheKey);
        }
    }
    // Default implementation
    onNewItemsReady(items) {
        pushArray(this.items, items);
        return items;
    }
    // Default implementation.
    onItemsReady() {
        const viewData = this.asWritableListMediator.viewLevelData();
        // Get the data from the view level data 
        this.items = viewData.models.slice(0);
    }
    // Note that it is up to the caller to decide how to use the
    // cached value; we need to precisely tell where there is a value in the cache
    // for the corresponding key
    readMediatorFromCache(key) {
        return this.mediatorCache.get(key, this.defaultLivePeriod);
    }
    writeMediatorIntoCache(key, mediator) {
        this.mediatorCache.set(key, mediator, this.defaultLivePeriod, (evt) => {
            mediator.tearDown();
            return evt;
        });
    }
    addOnCacheExpireHandler(key) {
        this._onCacheExpireCallback = function (evt) {
            evt.preventDefault();
            return evt;
        };
        this.mediatorCache.addOnExpireHandler(key, this._onCacheExpireCallback);
    }
    removeOnCacheExpireHandler(key) {
        this.mediatorCache.rmOnExpireHandler(key, this._onCacheExpireCallback);
        this._onCacheExpireCallback = null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2JvbmUtYmFja2VkLWxpc3QtcGFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3BvbHB3YXJlL25neC1tdmMvc3JjL2xpYi9tdmMvYmFja2JvbmUtYmFja2VkLWxpc3QtcGFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFbkQsT0FBTyxFQUNILG9CQUFvQixFQUd2QixNQUFNLGtCQUFrQixDQUFDO0FBRTFCLE9BQU8sRUFDSCwrQkFBK0IsRUFDbEMsTUFBTSxrQkFBa0IsQ0FBQztBQVUxQixPQUFPO0FBQ1AsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFL0QsMkRBQTJEO0FBQzNELDhEQUE4RDtBQUM5RCxxRUFBcUU7QUFDckUsYUFBYTtBQUViLE1BQU0sT0FBZ0Isc0JBQ2xCLFNBQVEsbUJBQW1CO0lBUzNCO1FBQ0ksS0FBSyxFQUFFLENBQUM7UUFSRixzQkFBaUIsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBVWpDLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUM7SUFDdkMsQ0FBQztJQU1ELElBQWMsc0JBQXNCO1FBQ2hDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7UUFDNUIsT0FBTyxDQUFnQyxDQUFDO0lBQzVDLENBQUM7SUFFRCw0Q0FBNEM7SUFDbEMsb0NBQW9DLENBQUMsaUJBQXNCLEVBQUUsWUFBcUI7UUFFeEYsTUFBTSxXQUFXLEdBQXFDO1lBQ2xELFlBQVksRUFBRSxpQkFBaUI7WUFDL0IsUUFBUSxFQUFFLElBQUk7WUFDZCxjQUFjLEVBQUUsSUFBSTtZQUNwQixhQUFhLEVBQUUsSUFBSTtTQUN0QixDQUFDO1FBRUYsTUFBTSxDQUFDLEdBQUcsSUFBSSxvQkFBb0Is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QUFhLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFUywwQkFBMEIsQ0FBQyxHQUFXO1FBQzVDLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUM7SUFDdkMsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IElWaWV3SW5zdGFuY2UgfSBmcm9tICdAcG9scHdhcmUvZmUtbXZjJztcblxuaW1wb3J0IHsgcHVzaEFycmF5IH0gZnJvbSAnQHBvbHB3YXJlL2ZlLXV0aWxpdGllcyc7XG5cbmltcG9ydCB7XG4gICAgV3JpdGFibGVMaXN0TWVkaWF0b3IsXG4gICAgSVdyaXRhYmxlTGlzdE1lZGlhdG9yQ3Rvck9wdGlvbnMsXG4gICAgSVdyaXRhYmxlTGlzdE1lZGlhdG9yUHVibGljXG59IGZyb20gJ0Bwb2xwd2FyZS9mZS1tdmMnO1xuXG5pbXBvcnQge1xuICAgIFJ4anNQb3dlcmVkV3JpdGFibGVMaXN0TWVkaWF0b3Jcbn0gZnJvbSAnQHBvbHB3YXJlL2ZlLW12Yyc7XG5cbmltcG9ydCB7XG4gICAgSUNvbGxlY3Rpb25JdGVtXG59IGZyb20gJ0Bwb2xwd2FyZS9mZS1kYXRhJztcblxuaW1wb3J0IHtcbiAgICBJU2xpZGluZ0V4cGlyZUNhY2hlXG59IGZyb20gJ0Bwb2xwd2FyZS9mZS1kYXRhJztcblxuLy8gYmFzZVxuaW1wb3J0IHsgRnVsbEZlYXR1cmVMaXN0UGFnZSB9IGZyb20gJy4vZnVsbC1mZWF0dXJlLWxpc3QtcGFnZSc7XG5cbi8vIE5vdGUgdGhhdCB3ZSB1c2UgSUNvbGxlY3Rpb25JdGVtIHJhdGhlciB0aGFuIElNb2RlbExpa2UsXG4vLyBiZWNhdXNlIHdlIGFzc3VtZSB0aGUgbGVhc3QgcmVxdWlyZW1lbnQgZm9yIHRoZSBpbnB1dCB0eXBlLlxuLy8gUHJlY2lzZWx5LCB0aGUgb25seSByZXF1aXJlbWVudCBpcyB0aGF0IHRoZSBjb2xsZWN0aW9uIGl0ZW0gaGFzIGFuXG4vLyBpZCBmaWVsZC4gXG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBCYWNrYm9uZUJhY2tlZExpc3RQYWdlPFQgZXh0ZW5kcyBJQ29sbGVjdGlvbkl0ZW0+XG4gICAgZXh0ZW5kcyBGdWxsRmVhdHVyZUxpc3RQYWdlIHtcblxuICAgIHByb3RlY3RlZCBkZWZhdWx0TGl2ZVBlcmlvZCA9IDYwICogNTtcblxuICAgIHByb3RlY3RlZCBtZWRpYXRvckNhY2hlOiBJU2xpZGluZ0V4cGlyZUNhY2hlPElXcml0YWJsZUxpc3RNZWRpYXRvclB1YmxpYz47XG4gICAgcHJpdmF0ZSBfb25DYWNoZUV4cGlyZUNhbGxiYWNrOiBhbnk7XG5cbiAgICBwdWJsaWMgaXRlbXM6IFRbXTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuaXRlbXMgPSBbXTtcbiAgICAgICAgdGhpcy5fb25DYWNoZUV4cGlyZUNhbGxiYWNrID0gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBXZSB1c2UgYSBmdW5jdG9uIHRvIGNvbXB1dGUgY2FjaGVLZXksIHNvIHRoYXQgd2UgY2FuXG4gICAgLy8gY29tcHV0ZSB0aGUgY2FjaGUga2V5IHdpdGggbW9yZSBpbnB1dHMuIFxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBnZXRDYWNoZUtleSguLi5hcmdzOiBhbnlbXSk6IHN0cmluZztcblxuICAgIHByb3RlY3RlZCBnZXQgYXNXcml0YWJsZUxpc3RNZWRpYXRvcigpOiBJV3JpdGFibGVMaXN0TWVkaWF0b3JQdWJsaWMge1xuICAgICAgICBjb25zdCBtID0gdGhpcy5saXN0TWVkaWF0b3I7XG4gICAgICAgIHJldHVybiBtIGFzIElXcml0YWJsZUxpc3RNZWRpYXRvclB1YmxpYztcbiAgICB9XG5cbiAgICAvLyBEZWZhdWx0IGltcGxlbWVudGF0aW9uIGZvciB1c2luZyBiYWNrYm9uZVxuICAgIHByb3RlY3RlZCB1c2VNZWRpYXRvcldpdGhPbmx5TG9jYWxEYXRhUHJvdmlkZXIobG9jYWxEYXRhUHJvdmlkZXI6IGFueSwgbG9jYWxPcHRpb25zPzogb2JqZWN0KSB7XG5cbiAgICAgICAgY29uc3QgY3Rvck9wdGlvbnM6IElXcml0YWJsZUxpc3RNZWRpYXRvckN0b3JPcHRpb25zID0ge1xuICAgICAgICAgICAgZGF0YVByb3ZpZGVyOiBsb2NhbERhdGFQcm92aWRlcixcbiAgICAgICAgICAgIHVzZU1vZGVsOiB0cnVlLFxuICAgICAgICAgICAgZW5hYmxlSW5maW5pdGU6IHRydWUsXG4gICAgICAgICAgICBlbmFibGVSZWZyZXNoOiB0cnVlXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcyA9IG5ldyBXcml0YWJsZUxpc3RNZWRpYXRvcihjdG9yT3B0aW9ucyk7XG4gICAgICAgIHRoaXMubGlzdE1lZGlhdG9yID0gcztcbiAgICAgICAgdGhpcy5saXN0TWVkaWF0b3Iuc2V0VXAoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgdXNlTWVkaWF0b3JXaXRoR2xvYmFsRGF0YVByb3ZpZGVyKGxvY2FsRGF0YVByb3ZpZGVyOiBhbnksIGdsb2JhbERhdGFQcm92aWRlcjogYW55LFxuICAgICAgICBsb2NhbE9wdGlvbnM/OiBvYmplY3QsIGdsb2JhbE9wdGlvbnM/OiBvYmplY3QpIHtcblxuICAgICAgICBjb25zdCBtZWRpYXRvciA9IG5ldyBSeGpzUG93ZXJlZFdyaXRhYmxlTGlzdE1lZGlhdG9yKHtcbiAgICAgICAgICAgIGdsb2JhbFByb3ZpZGVyOiBnbG9iYWxEYXRhUHJvdmlkZXIsXG4gICAgICAgICAgICBmaWx0ZXJGbGFnczoge1xuICAgICAgICAgICAgICAgIGFkZGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJlbW92ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgdXBkYXRlZDogZmFsc2VcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkYXRhUHJvdmlkZXI6IGxvY2FsRGF0YVByb3ZpZGVyLFxuICAgICAgICAgICAgdXNlTW9kZWw6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5saXN0TWVkaWF0b3IgPSBtZWRpYXRvcjtcbiAgICAgICAgdGhpcy5saXN0TWVkaWF0b3Iuc2V0VXAoKTtcbiAgICB9XG5cbiAgICAvLyBJbnZva2VkIGFmdGVyIHRoZSBuZXcgbWVkaWF0b3IgaXMgY29uc3RydWN0dXJlIFxuICAgIHByb3RlY3RlZCBwb3N0VXNlRnJlc2hNZWRpYXRvciguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICB0aGlzLnR1cm5Pbk1lZGlhdG9yKGZhbHNlLCAuLi5hcmdzKTtcbiAgICAgICAgdGhpcy5hZnRlck1lZGlhdG9yT24oKTtcbiAgICB9XG5cbiAgICAvLyBJbnZva2VkIGFmdGVyIHRoZSBjYWNoZWQgbWVkaWF0b3IgaXMgdXNlZCBcbiAgICBwcm90ZWN0ZWQgcG9zdFVzZUNhY2hlZE1lZGlhdG9yKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAgIHRoaXMudHVybk9uTWVkaWF0b3IodHJ1ZSwgLi4uYXJncyk7XG4gICAgICAgIHRoaXMuYWZ0ZXJNZWRpYXRvck9uKCk7XG4gICAgfVxuXG4gICAgLy8gT3ZlcnJpZGUgdG8gc3VwcG9ydCBjYWNoZVxuICAgIHByb3RlY3RlZCBlbnN1cmVEYXRhUHJvdmlkZXIoLi4uYXJnczogYW55W10pIHtcbiAgICAgICAgaWYgKHRoaXMubWVkaWF0b3JDYWNoZSkge1xuXG4gICAgICAgICAgICBjb25zdCBjYWNoZUtleSA9IHRoaXMuZ2V0Q2FjaGVLZXkoLi4uYXJncyk7XG4gICAgICAgICAgICBsZXQgaW5DYWNoZSA9IGZhbHNlO1xuXG4gICAgICAgICAgICBjb25zdCBtZWRpYXRvciA9IHRoaXMucmVhZE1lZGlhdG9yRnJvbUNhY2hlKGNhY2hlS2V5KTtcblxuICAgICAgICAgICAgaWYgKCFtZWRpYXRvcikgeyAvLyBOb3QgaW4gY2FjaGVcblxuICAgICAgICAgICAgICAgIHRoaXMuYnVpbGRNZWRpYXRvciguLi5hcmdzKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHVwIGluIHRoZSBjYWNoZVxuICAgICAgICAgICAgICAgICAgICB0aGlzLndyaXRlTWVkaWF0b3JJbnRvQ2FjaGUoY2FjaGVLZXksIHRoaXMuYXNXcml0YWJsZUxpc3RNZWRpYXRvcik7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY2FzZSAxOlxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc3RVc2VGcmVzaE1lZGlhdG9yKHRydWUsIC4uLmFyZ3MpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9IGVsc2UgeyAvLyBJbiBjYWNoZVxuXG4gICAgICAgICAgICAgICAgaW5DYWNoZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5saXN0TWVkaWF0b3IgPSBtZWRpYXRvcjtcblxuICAgICAgICAgICAgICAgIC8vIENhc2UgMjpcbiAgICAgICAgICAgICAgICB0aGlzLnBvc3RVc2VDYWNoZWRNZWRpYXRvciguLi5hcmdzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICB0aGlzLmJ1aWxkTWVkaWF0b3IoLi4uYXJncykudGhlbigoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBDYXNlIDM6IFxuICAgICAgICAgICAgICAgIHRoaXMucG9zdFVzZUZyZXNoTWVkaWF0b3IoZmFsc2UsIC4uLmFyZ3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBPdmVycmlkZVxuICAgIHByb3RlY3RlZCBhZnRlck1lZGlhdG9yT24oKSB7XG4gICAgICAgIGlmICh0aGlzLm1lZGlhdG9yQ2FjaGUpIHtcbiAgICAgICAgICAgIC8vIEluIHRoaXMgY2FzZSwgd2UgZG8gbm90IFByb3ZpZGUgYW55IGlucHV0cyBcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlS2V5ID0gdGhpcy5nZXRDYWNoZUtleSgpO1xuICAgICAgICAgICAgdGhpcy5hZGRPbkNhY2hlRXhwaXJlSGFuZGxlcihjYWNoZUtleSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBPdmVycmlkZVxuICAgIHByb3RlY3RlZCBhZnRlck1lZGlhdG9yT2ZmKCkge1xuICAgICAgICBpZiAodGhpcy5tZWRpYXRvckNhY2hlKSB7XG4gICAgICAgICAgICAvLyBJbiB0aGlzIGNhc2UsIHdlIGRvIG5vdCBQcm92aWRlIGFueSBpbnB1dHNcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlS2V5ID0gdGhpcy5nZXRDYWNoZUtleSgpO1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVPbkNhY2hlRXhwaXJlSGFuZGxlcihjYWNoZUtleSk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIC8vIERlZmF1bHQgaW1wbGVtZW50YXRpb25cbiAgICBwdWJsaWMgb25OZXdJdGVtc1JlYWR5KGl0ZW1zOiBBcnJheTxhbnk+KTogQXJyYXk8YW55PiB7XG4gICAgICAgIHB1c2hBcnJheSh0aGlzLml0ZW1zLCBpdGVtcyk7XG4gICAgICAgIHJldHVybiBpdGVtcztcbiAgICB9XG5cbiAgICAvLyBEZWZhdWx0IGltcGxlbWVudGF0aW9uLlxuICAgIG9uSXRlbXNSZWFkeSgpIHtcbiAgICAgICAgY29uc3Qgdmlld0RhdGEgPSB0aGlzLmFzV3JpdGFibGVMaXN0TWVkaWF0b3Iudmlld0xldmVsRGF0YSgpO1xuICAgICAgICAvLyBHZXQgdGhlIGRhdGEgZnJvbSB0aGUgdmlldyBsZXZlbCBkYXRhIFxuICAgICAgICB0aGlzLml0ZW1zID0gdmlld0RhdGEubW9kZWxzLnNsaWNlKDApO1xuICAgIH1cblxuICAgIC8vIE5vdGUgdGhhdCBpdCBpcyB1cCB0byB0aGUgY2FsbGVyIHRvIGRlY2lkZSBob3cgdG8gdXNlIHRoZVxuICAgIC8vIGNhY2hlZCB2YWx1ZTsgd2UgbmVlZCB0byBwcmVjaXNlbHkgdGVsbCB3aGVyZSB0aGVyZSBpcyBhIHZhbHVlIGluIHRoZSBjYWNoZVxuICAgIC8vIGZvciB0aGUgY29ycmVzcG9uZGluZyBrZXlcbiAgICBwcm90ZWN0ZWQgcmVhZE1lZGlhdG9yRnJvbUNhY2hlKGtleTogc3RyaW5nKTogSVdyaXRhYmxlTGlzdE1lZGlhdG9yUHVibGljIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWVkaWF0b3JDYWNoZS5nZXQoa2V5LCB0aGlzLmRlZmF1bHRMaXZlUGVyaW9kKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgd3JpdGVNZWRpYXRvckludG9DYWNoZShrZXk6IHN0cmluZywgbWVkaWF0b3I6IElXcml0YWJsZUxpc3RNZWRpYXRvclB1YmxpYyk6IHZvaWQge1xuICAgICAgICB0aGlzLm1lZGlhdG9yQ2FjaGUuc2V0KGtleSwgbWVkaWF0b3IsIHRoaXMuZGVmYXVsdExpdmVQZXJpb2QsIChldnQpID0+IHtcbiAgICAgICAgICAgIG1lZGlhdG9yLnRlYXJEb3duKCk7XG4gICAgICAgICAgICByZXR1cm4gZXZ0O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYWRkT25DYWNoZUV4cGlyZUhhbmRsZXIoa2V5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fb25DYWNoZUV4cGlyZUNhbGxiYWNrID0gZnVuY3Rpb24oZXZ0KSB7XG4gICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIHJldHVybiBldnQ7XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5tZWRpYXRvckNhY2hlLmFkZE9uRXhwaXJlSGFuZGxlcihrZXksIHRoaXMuX29uQ2FjaGVFeHBpcmVDYWxsYmFjayk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHJlbW92ZU9uQ2FjaGVFeHBpcmVIYW5kbGVyKGtleTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMubWVkaWF0b3JDYWNoZS5ybU9uRXhwaXJlSGFuZGxlcihrZXksIHRoaXMuX29uQ2FjaGVFeHBpcmVDYWxsYmFjayk7XG4gICAgICAgIHRoaXMuX29uQ2FjaGVFeHBpcmVDYWxsYmFjayA9IG51bGw7XG4gICAgfVxuXG59XG5cbiJdfQ==